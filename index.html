<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>Documentario de prensa y calendario de las representaciones de ópera italiana organizadas por Carlo Broschi Farinelli durante el reinado de Fernando VI y Bárbara de Braganza (1747–1758)</title>

  <style>

.intro-con-decoracion {
  display: flex;
  align-items: stretch; /* estira los hijos al mismo alto */
  background-color: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  overflow: hidden;
}

.intro-con-decoracion img {
  height: auto;       /* deja que la altura se adapte a su contenido */
  width: auto;
  max-height: 100%;   /* nunca supera la altura del contenedor */
  object-fit: cover;  /* recorta si es necesario, sin deformar */
  flex-shrink: 0;     /* no dejar que se reduzca */
}

.intro-con-decoracion p {
  flex: 1;
  padding: 20px;
  margin: 0;
}


/* Móvil: imagen arriba, texto debajo */
@media (max-width: 600px) {
  .intro-con-decoracion {
    flex-direction: column;
  }
  .intro-con-decoracion img {
    width: 100%;
    height: auto;
    border-radius: 10px 10px 0 0;
  }
  .intro-con-decoracion p {
    padding: 15px;
  }
}




    body {
      font-family: "Georgia", "Times New Roman", serif;
      padding: 30px;
      background-color: #f4f4f4;
      color: #2b2b2b;
    }
    /* Título general */
    h1 {
      color: #1f2d3d; 
      font-size: 1.3em; /* tamaño del título */
      margin-bottom: 0.8em;
      text-align: center; /* Centrado */
      line-height: 1.4; /* ↑ interlineado más amplio */
    
      max-width: 850px;          /* Limita el ancho del título */
      margin: 0 auto 1em auto;   /* Centrado y espacio inferior */
    }

  /* Texto bajo el título, centrado */
        .intro-centrada {
        text-align: center;
        max-width: 1000px;
        margin: 0 auto;
            line-height: 1.2; /* ↑ interlineado */

      }

      /* h2 = epígrafes */
    .intro-recuadro h2 {
    font-size: 1.25em;
    color: #1f2d3d;
    margin-top: 20px;
    margin-bottom: 10px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 4px;
    }
        /* Texto de epígrafes de Herramientas y Criterios de normalización */
        .intro-recuadro p,
        .intro-recuadro li {
          line-height: 1.4; /* ajusta el interlineado */
        }
    
/* Acordeones unificados */
.intro-recuadro .acordeon {
  max-width: 850px;      /* ancho del botón */
  width: 100%;
  margin: 6px auto 0;    /* centra el botón horizontalmente */
  padding: 6px 12px;
  font-size: 1em;
  cursor: pointer;
  background-color: #e9ecef;
  border-radius: 5px;
  border-bottom: 1px solid #ddd;
  position: relative;
  user-select: none;
  text-align: center;
}


.intro-recuadro .acordeon::after {
  content: '▼';
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  transition: transform 0.3s ease;
}
.intro-recuadro .acordeon.abierto::after {
  transform: translateY(-50%) rotate(-180deg);
}


.intro-recuadro .panel {
    display: block;  
    max-height: 0;   
    overflow: hidden;
    padding: 0 20px;            
    background-color: #ffffff;
    border-radius: 0 0 5px 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    margin: 0 auto;              /* centra el panel horizontalmente */
    transition: max-height 0.3s ease, padding 0.3s ease;
    text-align: justify;         /* texto justificado */
    max-width: 850px;            /* ancho máximo del panel */
    width: 100%;                 
    box-sizing: border-box;
}

.intro-recuadro .panel.abierto {
    max-height: 2000px;
    padding: 15px 20px;          
    margin-bottom: 15px;         /* margen solo cuando está abierto */
}




        .acordeon:hover {
        background-color: #d0e2f0; /* cambia ligeramente el fondo */
        color: #0f3c61;             /* opcional: cambia color del texto */
      }
        .intro-recuadro .acordeon.abierto::after {
        transform: rotate(-180deg);
        }


    p {
      max-width: 1100px;
      line-height: 1.6;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 5px;
      background: white;
      font-family: Arial, sans-serif;
      font-size: 0.95em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      vertical-align: top;
    }

    th {
      background-color: #e9ecef;
      text-align: left;
    }

    tr:nth-child(even) td {
      background-color: #fafafa;
    }

    .btn-trans {
      padding: 4px 9px;
      font-size: 0.85em;
      cursor: pointer;
      background-color: #1f6fb2;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-trans:hover {
      background-color: #164f80;
    }

    .transcripcion {
      display: none;
      background-color: #fffdf7;
      padding: 12px 16px;
      border-left: 4px solid #d4a017;
      margin-top: 8px;
      font-size: 0.95em;
      line-height: 1.5;
    }



    mark {
      background-color: #ffe58a;
      padding: 0 2px;
    }

    #info, #cita {
      margin-top: 30px;
      font-size: 0.9em;
      color: #444;
      max-width: 1100px;
    }

    #cita {
      background: #ffffff;
      border-left: 5px solid #1f6fb2;
      padding: 15px 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .cita-bloque {
      margin-bottom: 12px;
    }

    .btn-copiar {
      margin-top: 4px;
      font-size: 0.8em;
      padding: 3px 8px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      border-radius: 4px;
    }

    .btn-copiar:hover {
      background: #e2e2e2;
    }
    /* --- Centrado del buscador --- */
#buscador-container {
  text-align: center;
  margin: 25px 0;
}

#buscador-container button {
  margin-left: 5px;
}

        /* DESDE AQUÍ: DISEÑO DEL BOTÓN 'Mostrar todas...' */
.btn-todas-container {
  text-align: center;       /* centra el botón horizontalmente */
  margin: 2px 0 2px 0;    /* espacio arriba y abajo */
}

.btn-todas-container button {
  display: inline-flex;        /* para alinear icono y texto */
  align-items: center;
  justify-content: center;
  gap: 6px;                    /* menos espacio entre icono y texto */
  width: auto;                  /* que no sea tan ancho */
  padding: 6px 12px;            /* más pequeño */
  font-size: 0.9em;             /* letra más pequeña */
  font-weight: 500;             
  cursor: pointer;
  border-radius: 6px;           /* esquinas ligeramente redondeadas */
  background-color: #4da6ff;    
  color: #ffffff;               
  border: 1px solid #3399ff;    
  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  transition: background-color 0.2s ease, transform 0.2s ease;
}

.btn-todas-container button:hover {
  background-color: #3399ff;    
}


    /* Contenedor central para evitar estiramiento en pantallas grandes */
.contenedor {
  max-width: 1200px;
  margin: 0 auto;      /* Centra el contenido */
}
    /* Texto de la introducción más grande */
.introduccion p {
  font-size: 1em;
}

    .intro-recuadro {
  background-color: #ffffff;               /* fondo blanco */
  padding: 15px 20px;                      /* espacio interno */
  border-radius: 10px;                     /* esquinas redondeadas */
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);/* sombra suave */
  margin-bottom: 30px;                     /* separación del resto de contenido */
}

.intro-recuadro p {
  font-size: 1.1em;                        /* texto más grande */
  line-height: 1.6;
}

   
.nota-autor {
  padding-top: 12px;
  border-top: 1px solid #ddd;
  font-size: 0.95rem;
  line-height: 1.4;
  color: #555;
  text-align: center;
  max-width: 850px;
  margin: 20px auto 30px auto; /* margen superior y espacio inferior */
}



    /* CONTENEDOR DEL BUSCADOR */
.buscador-recuadro {
  background-color: #ffffff;
  padding: 15px 20px;                /* igual que .intro-recuadro */
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  margin: 30px auto;                 /* centrado y margen inferior */
  text-align: center;
  max-width: 1200px;                 /* igual que contenedor principal */
}




/* CONTENEDOR INPUT + ICONO */
.input-con-icono {
  position: relative;
  display: inline-block;
  width: 70%;       /* ancho total de la barra de búsqueda */
  max-width: 600px;
  margin-bottom: 7px;
}

/* INPUT DE TEXTO */
.input-con-icono input {
  width: 100%;
  padding: 14px 20px 14px 40px; /* espacio para la lupa */
  font-size: 1.1em;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
}

/* ICONO LUPA */
.input-con-icono .icono-buscar {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  pointer-events: none; /* no interfiere al escribir */
  stroke: #555;
  stroke-width: 2;
}
    .input-con-icono .icono-buscar * {
  pointer-events: none;
}


/* BOTÓN BUSCAR */
.buscador-recuadro button {
  padding: 12px 20px;
  font-size: 1.05em;
  margin-left: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  cursor: pointer;
  background-color: #1f6fb2;
  color: white;
  transition: background-color 0.2s;
}

.buscador-recuadro button:hover {
  background-color: #164f80;
}

/* RESULTADOS */
#resultado-busqueda {
  margin-top: 15px;
  font-weight: bold;
  color: #1f6fb2;
}


#resultado-busqueda {
  margin: 15px auto 0;
  font-weight: bold;
  color: #1f6fb2;
  text-align: center;
  width: 45%;       /* igual ancho que input */
}
    .intro-recuadro ul + p {
  margin-left: 0; /* quita el desplazamiento causado por el ul */
}

    /* Botones que apuntan a otra noticia */
.btn-ver-referencia {
  background-color: #6c757d; /* gris oscuro */
  color: white;
}

.btn-ver-referencia:hover {
  background-color: #495057; /* gris más oscuro al pasar el ratón */
}

    /* Centrar botones dentro de la tabla */
td button.btn-trans,
td button.btn-ver-referencia {
  display: block;   /* convierte el botón en bloque */
  margin: 0 auto;   /* margen automático a izquierda y derecha */
}
    

.intro-justificado {
  text-align: justify;           /* justifica el texto */
  max-width: 850px;             /* ancho máximo para que no se estire demasiado */
  margin: 0 auto;                /* centra el contenedor horizontalmente */
  line-height: 1.5;              /* interlineado cómodo */
}

.intro-justificado p {
  margin-bottom: 1em;            /* espacio entre párrafos */
}

  </style>
</head>

<body>
    <div class="contenedor">
  <h1>
    Documentario de prensa y calendario de las representaciones de ópera italiana 
    organizadas por Carlo Broschi Farinelli durante el reinado de Fernando VI y Bárbara de Braganza (1747–1758)
  </h1>

<div class="intro-con-decoracion">
  <img src="https://raw.githubusercontent.com/dmartinsaez/gmh/main/farinelli.jpg" alt="Farinelli">
  <p>
    <!-- Pergamino -->
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#1f6fb2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right:6px;">
      <path d="M4 2H20V22H4V2Z" stroke="#1f6fb2" stroke-width="2" fill="none"/>
      <line x1="6" y1="6" x2="18" y2="6" stroke="#1f6fb2" stroke-width="2"/>
      <line x1="6" y1="10" x2="18" y2="10" stroke="#1f6fb2" stroke-width="2"/>
      <line x1="6" y1="14" x2="18" y2="14" stroke="#1f6fb2" stroke-width="2"/>
    </svg>
    Este documentario incluye las transcripciones de todas las noticias sobre las óperas realizadas en el Coliseo del Buen Retiro de Madrid durante este periodo, publicadas en la <em>Gaceta de Madrid</em> y en el <em>Mercurio histórico y político</em>, que hemos editado de forma crítica situándolas en su contexto celebrativo y performativo.
  </p>

  <p>
    <!-- Calendario -->
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#1f6fb2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right:6px;">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="#1f6fb2" stroke-width="2" fill="none"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="#1f6fb2" stroke-width="2"/>
      <line x1="8" y1="2" x2="8" y2="6" stroke="#1f6fb2" stroke-width="2"/>
      <line x1="16" y1="2" x2="16" y2="6" stroke="#1f6fb2" stroke-width="2"/>
    </svg>
    Para ello, hemos reconstruido el calendario de representaciones indicando el año y día de la representación, el título de las óperas, los libretistas y compositores, la ocasión festiva y las fuentes consultadas.
  </p>

  <p>
    <!-- Gráfico -->
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#1f6fb2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right:6px;">
      <rect x="4" y="10" width="4" height="10" stroke="#1f6fb2" stroke-width="2" fill="none"/>
      <rect x="10" y="6" width="4" height="14" stroke="#1f6fb2" stroke-width="2" fill="none"/>
      <rect x="16" y="2" width="4" height="18" stroke="#1f6fb2" stroke-width="2" fill="none"/>
    </svg>
    En total, hemos podido identificar más de 300 noches de ópera, sobre las cuales hemos hallado más de 140 noticias distintas (sin contar las repetidas en ambas gacetas), que informan de una o más fechas de representaciones, cubriendo al menos 165 del total.
  </p>
</div>



<div class="nota-autor">
  Este recurso ha sido creado por Daniel Martín Sáez (Universidad de Salamanca) en el marco del proyecto LexiMus-USAL (2023–2026), financiado por el Ministerio de Ciencia e Innovación de España, PID2022-139589NB-C33.
</div>

<div class="intro-recuadro">

  <h3 class="acordeon">Herramientas interactivas</h3>
  <div class="panel">
          <p>Para facilitar la consulta del documentario, hemos incluido cuatro herramientas interactivas:</p>
          <ul>
            <li>El <strong>Buscador</strong>, que permite identificar términos, sintagmas y fragmentos léxicos en todas las noticias, contar sus ocurrencias y consultarlas en su contexto, desplegando únicamente las noticias donde aparecen.</li>
            <li>El botón <strong>Mostrar todas las noticias</strong>, que permite mostrar u ocultar todas las noticias a la vez dentro del calendario.</li>
            <li>El botón <strong>Ver noticia</strong>, que permite mostrar u ocultar cada noticia nueva de manera individual.</li>
           <li>El botón <strong>Véase la noticia nº x</strong>, con un color distinto, que permite visualizar de manera clara las noticias ya citadas donde se recogen varias fechas o rangos de fechas, alcanzando al menos 165 del total.</li>

          </ul>
  </div>     
  
  <h3 class="acordeon">Búsqueda lexicográfica y criterios de normalización</h3>
  <div class="panel">            
          <p>Dado que se ha respetado en todo momento la grafía de la época, para facilitar la búsqueda lexicográfica se han adoptado cinco medidas básicas:</p>
            <ul>
            <li>Aunque se han mantenido los acentos, los diacríticos, las cursivas y el uso de mayúsculas y minúsculas, el buscador no distingue estos parámetros, lo que permite realizar búsquedas con facilidad (e. g., “ópera”, “opera” y “Opera” se consideran equivalentes).</li> 
            <li>Tampoco distingue entre palabras completas o incompletas, lo cual permite buscar por fragmentos léxicos (e. g., "celebr" sirve para hallar palabras como "celebridad", "celebrar", "celebraron", etc.).</li>
            <li>Además, identifica las letras duplicadas (e. g., "assistieron" es equivalente a "asistieron"), de modo que el estudioso no debe preocuparse por estas diferencias de grafía.</li>
            <li>Por el mismo motivo, identifica letras que tienden a confundirse en el siglo XVIII, como la 'g', la 'j' y la 'x' (e. g., "artaxerxes" puede hallarse buscando "Artajerjes"), o la 'b' y la 'v' (e. g., "haver" puede hallarse buscando "haber"), junto a otras muchas típicas del periodo: la 'i' y la 'y', la 'c' y la 'q', la 'th' y la 't', la 'ph' y la 'f', la 'ch' y la 'c', la 'c' y la 'z' (e. g., el buscador identifica "cristal", "christal" y "Crystàl", o "voces" y "vozes"), o conjuntos como 'mpt' por 'nt' (e. g., "sumptuoso" y "suntuoso").</li>
             <li>Finalmente, no contempla guiones ni espacios que aparecen a menudo en este tipo de fuentes (e. g., "cumple-años" y "cumple años" puede encontrarse buscando "cumpleaños").</li>
            </ul>
  </div> 
            
  <h3 class="acordeon">Fuentes, transcripción, referencias y abreviaturas</h3>
  <div class="panel">    
          
            <p>Para la elaboración del calendario, cada una de las fechas introducidas se ha corroborado en una diversidad de fuentes y referencias:</p>
            <ul>
              <li>Las noticias pertenecen a la <em>Gaceta de Madrid</em> y el <em>Mercurio histórico y político</em>, que hemos identificado y transcrito manualmente a partir de las digitalizaciones de la Hemeroteca Digital de la Biblioteca Nacional de España. Cuando las noticias eran virtualmente idénticas, sólo hemos transcrito una de ellas. Hemos mantenido la grafía de la época por su interés histórico, incluyendo el uso de mayúsculas, minúsculas, cursivas, diacríticos y acentos. Además, hemos incluido entre corchetes aclaraciones cuando lo hemos considerado necesario (por ejemplo, para clarificar las fechas concretas cuando su cita resulta confusa con expresiones como "la semana pasada", "el viernes pasado", etc.).</li>
              <li>Además, hemos recurrido a otras ediciones de fuentes y estudios para la reconstrucción del calendario. La mayoría de fechas y ocasiones festivas, así como otros datos adicionales, se publicaron en Daniel Martín Sáez, “Calendario festivo, fuentes y artistas de las óperas y serenatas organizadas por Farinelli para la corte de Fernando VI y Bárbara de Braganza”, en Luigi Verdi (ed.): <em>Mito, Storia & Sogno di Farinelli</em>, LIM, Lucca, 2021, pp. 265-307, cuya tabla final hemos mejorado sustancialmente.</li>
              <li>Todo ello lo indicamos en la tabla con abreviaturas, indicando a continuación los números de página:
              AL = Correspondencia entre el duque de Huéscar y Ordeñana, 7 de enero de 1749 (Madrid), Archivo de la Casa de Alba, Caja 105;
              C = Cartas de María Antonia a Isabel de Farnesio cit. en Emilio Cotarelo y Mori:
              <em>Orígenes y establecimiento de la ópera en España hasta 1800</em>, Tip. de la ‘Revista de Arch. Bibl. y Museos’, Madrid, 1917;
              CH = Correspondencia entre Carvajal y Huéscar ed. en Didier Ozanam (ed.):
              <em>La diplomacia de Fernando VI</em>, CSIC, Madrid, 1975;
              EH = <em>Misión en París</em>. Correspondencia particular entre el Marqués de la Ensenada y el Duque de Huéscar,
              ed. Didier Ozanam & Diego Téllez Alarcia, IER, Logroño, 2010;
              F = Carlo Broschi Farinelli: <em>Fiestas reales</em>, Turner, Madrid, 1992;
              GM = <em>Gaceta de Madrid</em>;
              K = Benjamin Keene: <em>The Private Correspondence</em>, Cambridge University Press, Cambridge, 1933;
              MH = <em>Mercurio histórico y político</em>;
              R = Francisco de Rávago: <em>Correspondencia reservada e inédita</em>, Aguilar, Madrid, 1936;
              SE = Sara Erro, <em>La música en la Real Cámara durante el reinado de Fernando VI y María Bárbara de Braganza (1746-1759)</em>, Tesis doctoral, UCM, Madrid, 2023.</li>
            </ul>
          
            <p>En el apartado "Compositores", los números entre paréntesis indican los actos de la ópera compuestos por cada compositor.</p>
  </div>
    
  <h2 class="acordeon">Cómo citar este recurso</h2>
  <div class="panel">

              <div class="cita-bloque">
                <strong>APA</strong><br>
                <span id="cita-apa"></span><br>
                <button class="btn-copiar" onclick="copiar('cita-apa')">Copiar</button>
              </div>
                <div class="cita-bloque">
                <strong>Chicago</strong><br>
                <span id="cita-chicago"></span><br>
                <button class="btn-copiar" onclick="copiar('cita-chicago')">Copiar</button>
              </div>
            
              <div class="cita-bloque">
                <strong>MLA</strong><br>
                <span id="cita-mla"></span><br>
                <button class="btn-copiar" onclick="copiar('cita-mla')">Copiar</button>
              </div>
  </div>
</div>

<div class="buscador-recuadro">
  <strong>BUSCADOR</strong><br><br>
  <div class="input-con-icono">
    <input type="text" id="buscar" placeholder="Escriba la palabra o sintagma que desea buscar...">
    <svg class="icono-buscar" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="7" stroke="#555" stroke-width="2" fill="none"/>
      <line x1="16" y1="16" x2="22" y2="22" stroke="#555" stroke-width="2"/>
    </svg>
  </div>
  <button onclick="buscar()">Buscar</button>
  <p id="resultado-busqueda"></p>
</div>

    <!-- DONDE PONGAS ESTO el botón de Mostrar todas las NOTICIAS -->
<div class="btn-todas-container">
  <button id="btn-toggle" onclick="toggleTodas(event)">
    <!-- Icono de ojo SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
      <circle cx="12" cy="12" r="2.5"/>
    </svg>
    <span class="btn-text">Mostrar todas las noticias</span>
  </button>
</div>




  <div id="tabla-funciones"></div>  <!-- DONDE PONGAS ESTO SE INSERTA LA TABLA CON FUENTES -->
</div>
    
<script>
/* ---------- VARIABLES GLOBALES ---------- */
let todasVisibles = false;
transMap = {};

/* ---------- FUNCIONES DE TRANSCRIPCIÓN ---------- */
function toggleTrans(boton, divId) {
  const div = document.getElementById(divId);
  const visible = getComputedStyle(div).display !== 'none';
  div.style.display = visible ? 'none' : 'block';
  const textoOriginal = boton.getAttribute('data-text-original');
  boton.textContent = visible ? textoOriginal : 'Ocultar noticia';
}

function toggleTodas(event) {
  todasVisibles = !todasVisibles;
  document.querySelectorAll('.transcripcion').forEach(div => {
    div.style.display = todasVisibles ? 'block' : 'none';

const boton = div.previousElementSibling;
if (boton && boton.classList.contains('btn-trans')) {
  const textoOriginal = boton.getAttribute('data-text-original');
  boton.textContent = todasVisibles ? 'Ocultar noticia' : textoOriginal;
}

    
  });
event.target.querySelector('.btn-text').textContent = todasVisibles ? 'Ocultar todas las noticias' : 'Mostrar todas las noticias';
}

/* ---------- FUNCIONES DE NORMALIZACIÓN Y BÚSQUEDA ---------- */
function normalizar(str) {
  return str.toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/ph/g,'f').replace(/th/g,'t').replace(/ch/g,'c')
    .replace(/[gx]/g,'j').replace(/[vb]/g,'b')
    .replace(/[iy]/g,'i').replace(/[cq]/g,'c').replace(/[cz]/g,'c')
    .replace(/\s|-/g,'').replace(/(.)\1+/g,'$1')
    .replace(/mpt/g,'nt')  // <-- equivalencia añadida
    .replace(/escena/g, 'scena') // <--- NUEVA REGLA
    ;

}

function marcarBusqueda(div, palabraNorm) {
  function normTexto(str) { return normalizar(str); }
  let contador = 0;

  function recorrerNodo(nodo) {
    if (nodo.nodeType === Node.TEXT_NODE) {
      const textoNorm = normTexto(nodo.textContent);
      let indices = [], start = 0;
      while (start <= textoNorm.length - palabraNorm.length) {
        if (textoNorm.slice(start, start + palabraNorm.length) === palabraNorm) {
          indices.push(start);
          start += palabraNorm.length;
        } else start++;
      }
      if (!indices.length) return;
      contador += indices.length;
      let nuevoHTML = '', origIdx = 0;
      indices.forEach(idxNorm => {
        let startOrig = origIdx;
        while (startOrig < nodo.textContent.length && normTexto(nodo.textContent.slice(0, startOrig)).length < idxNorm) startOrig++;
        let endOrig = startOrig;
        while (endOrig < nodo.textContent.length && normTexto(nodo.textContent.slice(startOrig, endOrig)).length < palabraNorm.length) endOrig++;
        nuevoHTML += nodo.textContent.slice(origIdx,startOrig) + '<mark>' + nodo.textContent.slice(startOrig,endOrig) + '</mark>';
        origIdx = endOrig;
      });
      nuevoHTML += nodo.textContent.slice(origIdx);
      const span = document.createElement('span');
      span.innerHTML = nuevoHTML;
      nodo.replaceWith(span);
    } else if (nodo.nodeType === Node.ELEMENT_NODE) {
      nodo.childNodes.forEach(recorrerNodo);
    }
  }

  div.childNodes.forEach(recorrerNodo);
  return contador;
}

function buscar() {
  const palabra = document.getElementById('buscar').value.trim();
  const info = document.getElementById('resultado-busqueda');
  if (!palabra) {
    info.textContent = '';
    document.querySelectorAll('.transcripcion').forEach(div => div.style.display='none');
    return;
  }
  const palabraNorm = normalizar(palabra);
  let total = 0;
  document.querySelectorAll('.transcripcion').forEach(div => {
    div.innerHTML = div.getAttribute('data-original');
    div.style.display='none';
    total += marcarBusqueda(div, palabraNorm);
    if (div.querySelector('mark')) div.style.display='block';
  });
  info.textContent = total === 1 ? '1 resultado encontrado' : `${total} resultados encontrados`;
}

document.getElementById('buscar').addEventListener('keydown', e => { if(e.key==='Enter') buscar(); });

/* ---------- CONSTRUCCIÓN DE LA TABLA ---------- */
fetch('archivo.json')
  .then(r => r.json())
  .then(data => construirTablaSegura(data));

function construirTablaSegura(data) {
  let html = '';
  let i = 0;
  
const seenTrans = {};


  
  while (i < data.length) {
    const fila = data[i];
    const añoActual = fila.Año || '';

    // Contar cuántas filas tienen el mismo año
    let filasMismoAño = 0;
    for (let j = i; j < data.length && (data[j].Año || '') === añoActual; j++) filasMismoAño++;

for (let k = 0; k < filasMismoAño; k++) {
    const f = data[i + k];
    html += '<tr>';
    html += `<td>${f.Año}</td>`;  // <--- Añadido
    html += `
        <td>${f['Nº'] || ''}</td>
        <td>${f['Día'] || ''}</td>
        <td>${f['Título'] || ''}</td>
        <td>${f['Libreto'] || ''}</td>
        <td>${f['Compositor'] || ''}</td>
        <td>${f['Ocasión'] || ''}</td>
        <td>${f['Fuentes'] || ''}</td>
    </tr>`;


if (f.Transcripción && f.Transcripción.trim()) {
  const transHTML = f.Transcripción
    .split(/(?<=\.\s)(?=\[\d+\])/g)
    .map(t => `<p>${t.trim()}</p>`).join('');
  const transDivId = `trans-${i + k}`;

  if (seenTrans[transHTML]) {
    const origen = seenTrans[transHTML];
    html += `
    <tr>
      <td colspan="8">
        <button class="btn-trans btn-ver-referencia" data-target="trans-${origen}">
          Véase la noticia nº ${origen + 1}
        </button>
      </td>
    </tr>`;
  } else {
    seenTrans[transHTML] = i + k;
    html += `
    <tr>
      <td colspan="8">
        <button class="btn-trans" data-text-original="Ver noticia" onclick="toggleTrans(this,'${transDivId}')">
          Ver noticia
        </button>
        <div id="${transDivId}" class="transcripcion" style="display:none; text-align:left;" data-original='${transHTML.replace(/'/g,"&#39;")}'>
          ${transHTML}
        </div>
      </td>
    </tr>`;
  }
}


    }
    i += filasMismoAño;
  }

  document.getElementById('tabla-funciones').innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Año</th><th>Nº</th><th>Día</th><th>Título</th>
          <th>Libreto</th><th>Compositor</th><th>Ocasión</th><th>Fuentes</th>
        </tr>
      </thead>
      <tbody>${html}</tbody>
    </table>`;
}


/* ---------- ACORDEONES ---------- */
document.querySelectorAll('.acordeon').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const panel = btn.nextElementSibling;
    document.querySelectorAll('.panel').forEach(p=>{if(p!==panel)p.classList.remove('abierto')});
    document.querySelectorAll('.acordeon').forEach(b=>{if(b!==btn)b.classList.remove('abierto')});
    panel.classList.toggle('abierto');
    btn.classList.toggle('abierto');
  });
});

/* ---------- CITAS ---------- */
const autor = "Martín Sáez, Daniel";
const titulo = "Documentario de prensa y calendario de las representaciones de ópera italiana organizadas por Carlo Broschi Farinelli durante el reinado de Fernando VI y Bárbara de Braganza (1747–1758)";
const institucion = "Universidad de Salamanca";
const year = new Date().getFullYear();
const url = window.location.href;

document.getElementById('cita-apa').textContent = `${autor}. (${year}). ${titulo}. ${institucion}. ${url}`;
document.getElementById('cita-chicago').textContent = `${autor}. “${titulo}.” ${institucion}, ${year}. ${url}.`;
document.getElementById('cita-mla').textContent = `${autor}. ${titulo}. ${institucion}, ${year}. Web. ${url}.`;
function copiar(id){navigator.clipboard.writeText(document.getElementById(id).textContent);}



// ---------- BOTONES "Véase la noticia nº x" ----------
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-ver-referencia')) {
    const targetId = e.target.getAttribute('data-target');
    const div = document.getElementById(targetId);
    if (div) {
      const botonOriginal = div.previousElementSibling; // botón "Ver noticia" original
      const isVisible = getComputedStyle(div).display !== 'none';

      // Alternar visibilidad
      div.style.display = isVisible ? 'none' : 'block';

      // Cambiar texto del botón original
      if (botonOriginal && botonOriginal.classList.contains('btn-trans')) {
        botonOriginal.textContent = isVisible ? 'Ver noticia' : 'Ocultar noticia';
      }

      // Resaltar temporalmente
      div.scrollIntoView({behavior: "smooth", block: "center"});
      div.style.position = 'relative';
      div.style.boxShadow = '0 0 0 3px #1f6fb2 inset';
      setTimeout(()=> div.style.boxShadow='', 2000);
    }
  }
});


</script>


</div>
</body>
</html>
